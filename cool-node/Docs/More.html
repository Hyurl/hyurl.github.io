<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Docs: More | Cool-Node</title>
    <link rel="stylesheet" href="/cool-node/css/highlightjs-theme/monokai.css" />
    <link rel="stylesheet" href="/cool-node/css/vivify.min.css">
    <link rel="stylesheet" href="/cool-node/css/style.css">
</head>

<body>
    <header class="header vivify popInTop">
        <div class="logo">
            <a href="/cool-node/">Cool-Node</a>
        </div>
        <div class="change-lang">
            <a href="?lang=zh">中文</a>
        </div>
        <div class="navbar">
            <ul>
                <li><a href="/cool-node/">Home</a></li>
                <li><a href="/cool-node/Docs">Docs</a></li>
            </ul>
        </div>
        <div class="navbar-toggle">
            <button>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
        </div>
    </header>
    <div class="github-brand vivify fadeIn">
        <a href="https://github.com/Hyurl/cool-node" target="_blank" class="btn btn-default">
            <svg aria-hidden="true" class="octicon octicon-mark-github" version="1.1" viewBox="0 0 16 16" style="width:16px;height:16px;margin-bottom:-3px;">
                <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path>
            </svg> Fork Me on GitHub
        </a>
    </div>
    <div class="container vivify fadeIn">
        <aside class="sidebar vivify fadeIn">
            <ul>
                <li><a href="/cool-node/Docs/GettingStarted">Getting Started</a></li>
                <li>
                    <a href="javascript:;">The Basics</a>
                    <ul>
                        <li><a href="/cool-node/Docs/Concepts">Concepts</a></li>
                        <li><a href="/cool-node/Docs/WritingHttpControllers">Writing HTTP Controllers</a></li>
                        <li><a href="/cool-node/Docs/WritingSocketControllers">Writing Socket Controllers</a></li>
                        <li><a href="/cool-node/Docs/DesigningViews">Designing Views</a></li>
                    </ul>
                </li>
                <li><a href="/cool-node/Docs/Modelar">Modelar ORM</a></li>
                <li><a href="/cool-node/Docs/Mail">Sending E-Mail</a></li>
                <li><a href="/cool-node/Docs/More">More</a></li>
                <li><a href="/cool-node/Docs/MigrationGuide">Migration Guide</a></li>
            </ul>
        </aside>
        <article class="content vivify fadeIn">
            <h2 id="Create-a-Controller-that-Requires-Authentication">
                <a class="heading-anchor" href="#Create-a-Controller-that-Requires-Authentication">
                    <svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16">
                        <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
                    </svg>
                </a>Create a Controller that Requires Authentication
            </h2>
            <p>From the articles we talked before, you&#39;ve learned that there are two properties <code>req.user</code> and <code>socket.user</code>, but not knowing what they are used for. In this section, I will show you the most important usage that
                they possess.
            </p>
            <p>All controllers (HTTP or socket) have two properties <code>requireAuth</code> and
                <code>authorized</code>, these properties indicate whether the controller can be access directly by a client, or needs to be authorized before calling it.</p>
            <pre>
<code class="lang-javascript hljs">const <span class="hljs-type">HttpController</span> = require(<span class="hljs-string">"./HttpController"</span>);

module.exports = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">HttpController</span></span>{
    <span class="hljs-comment">/**
     * Controller's constructor accept a parameter: options, when you 
     * rewrite the constructor, you must define it.
     * The second parameter, judging by the controller type, can be either 
     * `req` or `socket`.
     */</span>
    constructor(options = {}, req = <span class="hljs-literal">null</span>){
        <span class="hljs-keyword">super</span>(options, req);

        <span class="hljs-comment">//If requireAuth is true, when calling the controller unauthorized, a </span>
        <span class="hljs-comment">//401 error will be thrown.</span>
        <span class="hljs-keyword">this</span>.requireAuth = <span class="hljs-literal">true</span>;

        <span class="hljs-comment">//You can even set the property authorized to indicate wheter the </span>
        <span class="hljs-comment">//operation is permitted, by default, it's:</span>
        <span class="hljs-keyword">this</span>.authorized = req &amp;&amp; req.user !== <span class="hljs-literal">null</span>;

        <span class="hljs-comment">//Also, because this is a HTTP controller, you can define a rollbackTo</span>
        <span class="hljs-comment">//property, when calling the controller unauthorized, instead of </span>
        <span class="hljs-comment">//throwing a 401 error, the client will be redirect to the given URL.</span>
        <span class="hljs-keyword">this</span>.rollbackTo = <span class="hljs-string">"/Login"</span>;
    }
}</code>
            </pre>
            <p>But, remember this feature only works when the controller is called from the client side, if it is called from the server side, it won&#39;t work.</p>
            <h2 id="Create-Multiple-Applications-in-One-Project">
                <a class="heading-anchor" href="#Create-Multiple-Applications-in-One-Project">
                    <svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16">
                        <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
                    </svg>
                </a>Create Multiple Applications in One Project
            </h2>
            <p>Yes, that&#39;s right, you can build more than one application in just one Cool-Node project. And more important is, it&#39;s very easy. All you have to do, is making another copy of the <code>node_modules/cool-node/App-example</code>, and
                name it with the style of <code>App.subdomain</code>, and the job is done. The rest work is just the same as you will do with the main application in <code>App</code>.</p>
            <p>Actually, the main application in <code>App</code> is also one of the apps in the project, it reserves the subdomain <code>www</code>, which means, if you visit
                <code>http://www.localhost</code>, it is just the same as you visit <code>http://localhost</code>. But if you visit <code>http://a.localhost</code>, and you don&#39;t have a folder in the project named <code>App.a</code>, a 404 error will
                be thrown.</p>
            <p>This feature is complemented by setting the <code>host</code> name in <code>/config.js</code>, when a client makes a request to the server, the framework will split the subdomain out from the setting host. That means, if you have a <code>App.a</code>                in you project, when you visit <code>http://a.localhost</code>, the app will run as expected, but if you visit <code>http://a.abc.com</code> (assume your DNS points abc.com to 127.0.0.1), the app will never run properly.</p>
            <p>Be aware, if you&#39;re using Windows as your development environment, you may not be able to visit <code>http://a.localhost</code> on some browsers, In my experience, only Chrome can access. If you&#39;re using other browsers like Firefox,
                Edge, etc., you may need to edit you <code>hosts</code> file in <code>C:\Windows\System32\drivers\etc\</code>, and add a line of contents like this:</p>
            <pre>
<code class="lang-sh hljs">127<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span>  <span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.localhost</span></code>
            </pre>
            <p>If you have the same problem on other platforms, also edit the <code>hosts</code> file, make sure the subdomain points to <code>127.0.0.1</code>.</p>
            <h2 id="Throw-and-Show-Errors-to-the-Client">
                <a class="heading-anchor" href="#Throw-and-Show-Errors-to-the-Client">
                    <svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16">
                        <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
                    </svg>
                </a>Throw and Show Errors to the Client
            </h2>
            <p>It&#39;s very easy to display an error, like <code>404 Not Found!</code>, to the client, just throw an Error in the controller method, the framework will automatically capture the error and try to display it to the client. Look at this example:</p>
            <pre>
<code class="lang-javascript hljs"><span class="hljs-comment">// /App/Controllers/HttpTest.js</span>
module.exports = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">HttpController</span></span>{
    get404(){
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-type">Error</span>(<span class="hljs-string">"404 Not Found!"</span>);
    }
}</code>
            </pre>
            <p>And when you visit <code>http://localhost/HttpTest/404</code>, an 404 error will be shown to you. It might not be the error message that you thrown, that depends on your views. If you have a <code>404.html</code> in <code>/App/Views/</code>,
                then the view file will be displayed, otherwise, the error message will be shown. This rule applies to all error types, like 400, 401, 403, 500, etc.</p>
            <p>If the error is thrown in a socket controller, then a failed message (like
                <code>{success: false, msg: &#39;404 Not Found!&#39;, code: 404}</code>) will be sent to the client.
            </p>
            <h2 id="Write-Your-Own-Middleware">
                <a class="heading-anchor" href="#Write-Your-Own-Middleware">
                    <svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16">
                        <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
                    </svg>
                </a>Write Your Own Middleware
            </h2>
            <p>You can write you own middleware and put them in <code>/Middleware/</code> (HTTP ones in <code>http/</code> and socket ones in <code>socket/</code>), like controllers, they will be automatically loaded when the server is running.</p>
            <p>For your most convenience, all middleware in the Cool-Node project keep all abilities to control the <em>Express</em> and <em>Socket.io</em>.</p>
            <p>There are two examples showing you how to write your own middleware.</p>
            <pre>
<code class="lang-javascript hljs"><span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">app</span>)</span>{
    <span class="hljs-comment">// /App/Middleware/http/test.js</span>
    app.use(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
        <span class="hljs-comment">//Do stuffs here...</span>
        next();
    });
};</code>
            </pre>
            <pre>
<code class="lang-javascript hljs"><span class="hljs-comment">// /App/Middleware/socket/test.js</span>
<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">io</span>)</span>{
    io.use(<span class="hljs-function">(<span class="hljs-params">socket, next</span>)=&gt;</span>{
        <span class="hljs-comment">//Do stuffs here...</span>
        next();
    });
};</code>
            </pre>
            <p>Be aware, because middleware files in <code>Middleware</code> are loaded automatically, the loading order is alphabetic, so if you have multiple files, you&#39;d better name them beginning with a number starts from 0.</p>
            <h2 id="Dealing-with-XML">
                <a class="heading-anchor" href="#Dealing-with-XML">
                    <svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16">
                        <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
                    </svg>
                </a>Dealing with XML
            </h2>
            <p>Since version 1.0.6, you can handle HTTP requests and responses with a header field <code>Content-Type: application/xml</code> (or <code>text/xml</code>). If this field presents in the request, the <code>req.body</code> will be automatically
                parsed to object; If you set this field to the response object, the response data will be automatically transferred to XML.</p>
            <pre>
<code class="lang-javascript hljs">module.exports = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">HttpController</span></span>{
    getShowXML(req, res){
        <span class="hljs-comment">//Send XML to the client, the object will be autoatically transferred</span>
        <span class="hljs-comment">//to XML.</span>
        res.<span class="hljs-keyword">type</span>(<span class="hljs-string">"xml"</span>);
        <span class="hljs-keyword">return</span> {a: <span class="hljs-string">"Hello"</span>, b: <span class="hljs-string">"World!"</span>};
    }
}</code>
            </pre>
            <h2 id="Broadcast-Message-in-a-HTTP-Controller">
                <a class="heading-anchor" href="#Broadcast-Message-in-a-HTTP-Controller">
                    <svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
        </svg>
                </a>Broadcast Message in a HTTP Controller
            </h2>
            <p>Version 1.1.0 adds two global variables <code>wsServer</code> and <code>wssServer</code>, they reference to the corresponding WebSocket servers created by <em>Socket.io</em>, which can be used in HTTP controllers to broadcast message through
                the WebSocket Channel.
            </p>
            <pre>
<code class="lang-javascript hljs">const <span class="hljs-type">HttpController</span> = require(<span class="hljs-string">"./HttpController"</span>);

module.exports = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">HttpController</span> </span>{
    postBroadcast(req, res){
        <span class="hljs-comment">//wsServer or wssServer may be null if the corresponding server is not</span>
        <span class="hljs-comment">//running.</span>
        <span class="hljs-keyword">if</span>(wsServer){
            wsServer.emit(<span class="hljs-string">"http-broadcast"</span>, req.body);
        }
        <span class="hljs-keyword">if</span>(wssServer){
            wssServer.emit(<span class="hljs-string">"http-broadcast"</span>, req.body);
        }
        <span class="hljs-keyword">return</span> req.body;
    }
}</code>
            </pre>
            <p>On the client side:</p>
            <pre>
<code class="lang-javascript hljs"><span class="hljs-title">socket</span>.on(<span class="hljs-string">"http-broadcast"</span>, function(<span class="hljs-class"><span class="hljs-keyword">data</span>){
    <span class="hljs-title">console</span>.<span class="hljs-title">log</span>("<span class="hljs-type">HTTP</span> <span class="hljs-type">Broadcast</span>: ", <span class="hljs-title">data</span>);
});</span></code>
            </pre>
            <h2 id="Run-Your-Server-Forever">
                <a class="heading-anchor" href="#Run-Your-Server-Forever">
                    <svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16">
                        <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
                    </svg>
                </a>Run Your Server Forever
            </h2>
            <p><code>forever</code> is a simple CLI tool for ensuring that a given script runs continuously. The reason why I introduce you it is that Node.js server may crash for unknown reasons, using <em>forever</em> will guarantee that your server will
                run continuously, that means even if the script crashed, it can be auto-restarted.
            </p>
            <p>To install <code>forever</code>, just run the following command (don&#39;t forget <code>-g</code>):</p>
            <pre>
<code class="lang-sh hljs">npm <span class="hljs-keyword">install</span> forever -g</code>
            </pre>
            <p>After installing, you can run the command <code>forever start index.js</code> in your Cool-Node project directory to check if you&#39;ve installed <em>forever</em> properly.</p>
            <p><em>Forever</em> will ensure that a script can run continuously only if the operating system is running. If the system has restarted, then all processes hosted by
                <em>forever</em> will stop. So we need to make <em>forever</em> auto-running after the system has rebooted.</p>
            <p>If your system is CetOS (other Linux platforms may be the same), edit the file
                <code>/etc/rc.local</code>, and add a new line to the bottom:</p>
            <pre>
<code class="lang-sh hljs">forever /root/cool-<span class="hljs-keyword">node</span><span class="hljs-title">-website</span>/index.js &gt; /dev/null</code>
            </pre>
            <p><code>/root/cool-node-website/index.js</code> is your Cool-Node project&#39;s entry file, don&#39;t forget to replace it to your specific path. More details about <code>forever</code> is covered at
                <a href="https://www.npmjs.com/package/forever">www.npmjs.com/package/forever</a>.</p>
            <p>Now you have gone through all the lessons, you can now write your applications as free as you want.</p>
        </article>
    </div>
    <div class="markdown-content">

    </div>
    <div id="anchor-pin">
        <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
        </svg>
    </div>

    <footer>
        <p class="text-center">
            <span id="copyright">©2017
                <a href="https://hyurl.github.io/cool-node/">Cool Node</a> <a href="https://github.com/Hyurl/cool-node/blob/master/update-log.md">1.2.4</a> based on
                <a href="http://nodejs.org/">Node.js</a> 6.0+.
            </span>
            <span id="license">Licensed under the
                <a target="_blank" href="http://spdx.org/licenses/MIT.html">MIT License</a>.
            </span>
            <span id="icp">
                <a href="http://www.miitbeian.gov.cn" target="_blank" style="color:#777">桂ICP备15001693号</a>
            </span>
        </p>
        <p class="text-center">See Other Projects:
            <a href="http://modelar.hyurl.com/">Modelar</a> |
            <a href="http://modphp.hyurl.com/">ModPHP</a> |
            <a href="http://modphp.hyurl.com/ModCMS/">ModCMS</a> |
            <a href="https://github.com/hyurl/type-storage">TypeStorage</a>
        </p>
    </footer>

    <script src="/cool-node/js/jquery.min.js"></script>
    <script src="/cool-node/js/soft-loader.js"></script>
    <script src="/cool-node/js/javascript.js"></script>
    <script src="/cool-node/js/marked.min.js"></script>
    <script src="/cool-node/js/highlight.pack.min.js"></script>
</body>

</html>